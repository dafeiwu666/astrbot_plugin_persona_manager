# Persona Manager 行为说明

本文档描述本插件在“角色注入 / 关键词触发 / 次数限制 / 外部 persona 一致性”等方面的运行行为，便于管理员理解插件在群聊与私聊中的表现。

## 1. 角色注入（on_llm_request）

- 插件在 `on_llm_request` 阶段运行。
- 若当前会话处于某个角色（非“休息模式”）且该角色内容非空：
  - 生成注入文本：
    - 默认：`角色内容`
    - 若该角色开启包装器：`default_prefix + 角色内容 + default_suffix`
  - 将注入文本**追加**到 `req.system_prompt` 末尾（不会覆盖其他插件/系统的 system prompt）。

## 2. 群聊/私聊上下文

- 插件会尽量把“当前角色”按上下文区分：
  - 私聊：按 `user_id` 维度保存/切换。
  - 群聊：按“稳定的群维度 key”保存/切换（优先 group_id，其次从 session_id/unified_msg_origin 回退）。
- 这意味着同一用户在不同群可使用不同角色。

## 3. 会话式创建/修改

- `/创建角色 名称` 与 `/修改设定 角色名` 是会话式交互：
  - 插件会提示用户依次输入简介、标签、是否使用包装器、设定内容。
  - 输入 `/结束角色编辑`（或等价结束命令）会保存并退出。
  - 超过 `session_timeout_sec` 未回复会自动超时退出。
- 为避免群聊“串话”或自触发：
  - 只接受“发起会话的用户”的后续消息。
  - 忽略机器人自身消息与“空回流事件”。

## 4. 关键词触发（event_message hook）

### 4.1 配置格式

`keyword_persona_triggers` 每行一条规则：

- `关键词:提示词`
- `~关键词:提示词`

匹配规则：
- `~` 开头：**包含匹配**（大小写不敏感）。
- 非 `~`：**完全匹配**（会先移除消息与关键词中的所有空白字符再比较；大小写敏感）。
- 允许以 `/关键词` 形式触发：匹配前会去掉前导 `/` 或 `／`。

### 4.2 触发后的注入行为

- 关键词触发只会注入“右侧提示词”，不会注入当前角色与前后缀。
- 插件会主动发起一次 LLM 请求，并尽量绑定到当前会话 Conversation，确保历史一致。

## 5. 每日次数限制（群聊/私聊）

- 插件对“LLM 触发”进行计数与限制：
  - 群聊：`group_llm_limit`
  - 私聊：`private_llm_limit`
- 白名单语义：
  - 未配置群白名单时，视为所有群“无限制”。
  - 未配置用户白名单时，视为所有用户“无限制”。
- 关键词触发会在发起 LLM 之前先计数；为避免 `on_llm_request` 重复计数，会使用一次性标记进行去重。

## 6. 外部 persona 一致性保护（external_persona_id）

当配置 `external_persona_id` 时：

- **普通注入路径（on_llm_request）**：
  - 若检测到“当前对话的外部 persona 已被切换为其它 ID”，且插件内部当前不是休息模式：
    - 自动切回休息模式。
    - 可选：按配置触发重置聊天记录。
    - 取消本次 LLM 请求并提示用户（避免把某个角色内容错配注入到另一外部 persona 对话里）。

- **关键词触发路径**：
  - 若检测到外部 persona 不一致：直接拦截本次关键词触发。

## 7. 切换角色后的附加动作

当执行 `/切换角色` 或 `/休息模式`：

- 可选：`auto_reset_on_switch=true` 时自动重置聊天记录。
- 可选：`sync_nickname_on_switch=true` 时同步昵称/群名片。
- 若切换到非休息模式且配置了 `external_persona_id`：插件会尝试将当前对话的外部 persona 统一切到该 ID。

## 8. CozyNook 导入/导出

- `/获取角色 ula-...` 会拉取帖子文本并以“合并转发”形式发送（可带最新评论）。
- 需要 `cozynook_sid_cookie` 才能访问鉴权接口。
- 导出附件时会下载到缓存目录，随后自动清理（延迟删除 + 定期裁剪）。
- 导入角色后会提示并切回休息模式，避免“导入即注入”导致误触发。
