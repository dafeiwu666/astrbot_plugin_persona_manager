## 📖 简介

本插件（**角色社区化人设管理**）为 AstrBot 提供“角色注入 / 人设管理”能力：你可以创建多个角色设定，并在对话时一键切换；插件会在 LLM 请求前把当前角色内容注入到 system prompt，从而让主 AI 以指定人设进行回复。

同时支持：
- **会话式创建/修改角色**（引导式输入简介、标签、设定内容）
- **群聊/私聊分别维护当前角色**（同一用户在不同群可使用不同角色）
- **关键词触发临时人设**（匹配关键词后仅注入对应提示词，不注入当前角色与前后缀）
- **CozyNook 社区角色小屋**（浏览帖子、导入为本地角色、导出附件；也可在网页端上传/发布人设并分享给大家）
- **可选：统一外部 persona、自动重置聊天记录、昵称/群名片同步**

## 必做
- **空人设**在astr的人设管理部分设置一个空人设(人设内容为空)，在配置项里填写此人设ID，即可用此插件全权代理人设部分。

## ✨ 特性

- **🧩 角色管理**：创建、查看、列表、标签搜索、切换、删除、修改设定
- **🧷 注入包装器**：可为角色内容套用统一的前置/后置提示词（`default_prefix` / `default_suffix`）
- **🧼 正则清洗（可选）**：可对“注入的角色内容”在注入前执行正则清洗（支持使用配置默认或每角色自定义）
- **🧠 LLM Hook 注入**：在 `on_llm_request` 阶段追加到 `system_prompt`，避免覆盖其它插件/系统预设
- **🧯 安全防循环**：忽略机器人自身消息与空回流事件，避免会话状态机自触发
- **🧾 每日次数限制**：支持群聊/私聊按日限额（可按白名单放行）
- **🏠 CozyNook 角色小屋**：支持 `ula-xxxxxxxxxxxxxxxx`（16位）密码获取/导入/导出

## 📦 安装

1. 确保你已经安装了 [AstrBot](https://github.com/Soulter/AstrBot)。
2. 将本插件文件夹放入 AstrBot 的 `data/plugins/` 目录下。
3. 安装依赖：CozyNook（角色小屋）联网功能依赖 `aiohttp`。
    ```bash
    pip install aiohttp
    ```
4. （可选）安装 Pillow：当使用 CozyNook“帖子预览图”渲染能力时需要。
   ```bash
   pip install pillow
   ```
5. 重启 AstrBot。

## 🔧 配置

配置项见插件自带 schema（`_conf_schema.json`）。常用项如下：

| 配置项 | 说明 | 备注 |
| :--- | :--- | :--- |
| `enabled` | 是否启用插件 | |
| `whitelist_user_ids` | 私聊白名单用户 | 为空表示不限制（所有用户允许/无限制） |
| `whitelist_group_ids` | 群聊白名单 | 为空表示不限制（所有群允许/无限制） |
| `private_llm_limit` | 私聊每日次数限制 | `-1` 不限制，`0` 禁用 |
| `group_llm_limit` | 群聊每日次数限制 | `-1` 不限制，`0` 禁用 |
| `default_prefix` / `default_suffix` | 角色注入前后缀 | 仅当角色启用包装器时生效 |
| `default_clean_regex` | 默认正则文本清洗表达式 | 对角色内容执行 `re.sub(pattern, '', text)`；留空表示不启用默认清洗 |
| `session_timeout_sec` | 会话式创建/编辑超时（秒） | |
| `external_persona_id` | 统一外部角色 ID | 配置后可实现“对话内外部 persona 统一” |
| `auto_reset_on_switch` | 切换角色时自动重置聊天记录 | |
| `sync_nickname_on_switch` | 切换角色时同步昵称/群名片 | 仅部分平台支持（如 aiocqhttp） |
| `nickname_sync_mode` / `nickname_template` | 昵称同步模式与模板 | 支持 `{persona_name}` 占位符 |
| `keyword_persona_triggers` | 关键词触发规则 | 每行一条：`关键词:提示词`；`~关键词` 为包含匹配 |
| `cozynook_sid_cookie` | Cozyverse 登录态 Cookie | 用于拉取需要鉴权的内容 |
| `cozynook_comments_take` | 拉取最新评论条数 | `0-50`，`0` 表示不拉取 |
| `cozynook_channel_cards_pick` | 角色小屋频道抽卡数量 | `1-30`，默认 15 |

## 💻 指令列表

### 🧑‍🎤 基础角色管理

| 指令 | 说明 |
| :--- | :--- |
| `/创建角色 名称` | 会话式创建角色（按提示输入简介/标签/设定内容） |
| `/角色列表` | 列出你的所有角色（合并转发） |
| `/查找角色` | 按标签搜索角色（会话式输入标签） |
| `/查看角色 名称` | 查看角色详情（含标签与简介） |
| `/切换角色 名称` | 切换当前会话（群/私聊维度）的角色 |
| `/休息模式` | 清空当前会话角色（不注入任何角色） |
| `/当前角色` | 查看当前会话正在使用的角色 |
| `/修改设定 角色名` | 会话式修改简介/标签/设定内容 |
| `/删除角色 名称` | 删除角色 |

### 🏠 CozyNook 角色小屋

CozyNook 是一个偏“社区分享”的角色小屋：你可以在网页端发布/上传人设，生成 `ula-xxxxxxxxxxxxxxxx`（16位）密码；群友通过本插件输入 ULA 即可一键拉取并导入。

同时，`/角色小屋` 会从指定分享码频道中随机抽取卡片，并直接给出“标题 + 密码”。

| 指令 | 说明 |
| :--- | :--- |
| `/角色小屋` | 输出频道分区列表 + 随机抽取卡片（标题 + 密码） |
| `/角色小屋 分区名` | 仅从该分区随机抽取卡片 |
| `/获取卡片 ula-xxxxxxxxxxxxxxxx` | 打开指定卡片/帖子（可选择导入或导出） |
| `/导入角色 ula-xxxxxxxxxxxxxxxx` | 直接导入为本地角色（导入后会切回休息模式） |
| `/导出角色 ula-xxxxxxxxxxxxxxxx` | 直接进入导出流程（选择附件序号下载） |

## 📌 行为说明

创建/导入角色时，会在步骤中询问：
- 是否使用“已配置好的前后置提示词”（/是：使用配置；/否：自定义填写；/跳过：不使用）
- 是否使用“已配置好的正则文本清洗表达式”（/是：使用配置；/否：自定义填写；/跳过：不使用）

插件在 LLM 注入、关键词触发、额度统计、外部 persona 一致性保护等方面有明确行为约定，详见 [BEHAVIOR.md](BEHAVIOR.md)。

## 🗂️ 数据存储

- 角色与状态持久化存放在 AstrBot 数据目录下：`astrbot_plugin_persona_manager/store.json`
- CozyNook 导出/下载会使用缓存目录（会定期清理）

## 🖼️ CozyNook 预览图开关

`/获取卡片` 默认使用“合并转发文本”展示帖子内容。你也可以在配置中开启图片预览渲染：

- `cozynook_use_preview_image`（默认 `false`）：
    - `false`：使用合并转发文本（兼容性最好）。
    - `true`：尝试将帖子内容渲染为预览图并发送；若渲染失败（缺依赖/字体不可用/运行环境限制），会自动回退为合并转发文本。

开启图片预览需要可选依赖：`Pillow`（安装：`pip install pillow`）。

字体相关：

- `cozynook_preview_font_path`（默认空）：可指定字体文件路径（例如 Windows 的 `C:/Windows/Fonts/msyh.ttc` 或 Linux 的 `/usr/share/fonts/...`）。
    - Docker/精简系统往往缺少中文字体，建议显式配置该路径，否则预览图可能无法渲染或中文显示异常。

## 关于社区
  这个社区的初衷本来是想给大家一个共享设定的平台，然后总感觉功能缺这缺那的，就变成了类频道的轻社区，没事就当设定共享平台用！
  关于API部分我也做了对应的后端接入API，以下是API文档：
      ### 1. 基础配置与鉴权
    **硬编码地址**：API 基地址硬编码在 [src/pm_commands_cozynook.py](src/pm_commands_cozynook.py) 中（根目录 [pm_commands_cozynook.py](pm_commands_cozynook.py) 仅做兼容转发），固定为 `https://c0zynook.com/api`。
      **强制鉴权**：
          必须在配置中填写 `cozynook_sid_cookie`。
          支持格式：`cv_auth=...`、`cv_sid=...` 或完整 Cookie 字符串。
          无 Cookie 将直接阻断流程。

      ### 2. 核心 API 逻辑
      插件主要按顺序调用以下接口（部分接口包含**首选新接口**与**回退旧接口**的兼容机制）：

      **频道抽卡 (By XB Invite)**：
          通过分享码加入频道后拉取内容列表，并从中随机抽取卡片（输出标题 + 密码）。
          路径：`POST /api/invites/join` + `GET /api/bootstrap`。
      
      **获取帖子内容 (By ULA/Password)**：
          通过 ULA 码检索帖子详情（ID、标题、作者、正文、附件列表等）。
          路径：`/api/v1/posts/by-password` (v1) 或 `/api/posts/by-password` (旧)。
      **获取评论 (可选)**：
          根据配置 (`cozynook_comments_take`) 拉取最新 N 条评论。
          路径：优先使用游标分页 `/cursor` (v1)，失败则回退至页码分页。
      
      ### 3. 插件功能实现
      基于上述 API，插件实现了以下四大功能：
    1.  **角色/帖子拉取**：指令 `/获取卡片 ula-xxxx`，以“合并转发”形式展示帖子详情（标题、简介、正文）。
      2.  **社区活跃展示**：在详情中附带最新评论内容。
      3.  **附件管理**：解析 Files 字段，支持按序号下载并发送图片/文件（含缓存与自动清理）。
      4.  **一键导入**：将在线帖子内容转换为本地角色卡（导入后自动切入休息模式以防冲突）。